# ✅ Визуальный Конструктор Формул - Реализовано!

## Что было сделано

### 1. **База данных** ✅
- Миграция: [0005_custom_formula_blocks.sql](supabase/migrations/0005_custom_formula_blocks.sql)
- Таблица `custom_formula_blocks` для хранения кастомных формул
- RLS policies для защиты данных
- Soft delete (is_active флаг)

### 2. **Backend API** ✅

- **POST** `/api/custom-formulas/[spCode]` - создание новой формулы
- **GET** `/api/custom-formulas/[spCode]` - получение списка формул для СП
- **PUT** `/api/custom-formulas/[id]` - редактирование существующей формулы
- **DELETE** `/api/custom-formulas/[id]` - удаление формулы (soft delete)
- **POST** `/api/custom-formulas/test` - тестирование выражения

### 3. **Frontend компоненты** ✅

- **FormulaBuilder** ([components/admin/FormulaBuilder.tsx](components/admin/FormulaBuilder.tsx))
  - Основной компонент конструктора
  - Редактор название, описание, LaTeX
  - Редактор параметров с inline тестированием
  - Редактор выражения расчёта
  - Встроенный тестер формул

- **ParamEditor** ([components/admin/ParamEditor.tsx](components/admin/ParamEditor.tsx))
  - Редактирование параметров формулы
  - Добавление/удаление параметров
  - Настройка названия, единиц, диапазонов

- **CustomFormulaManager** ([components/admin/CustomFormulaManager.tsx](components/admin/CustomFormulaManager.tsx))
  - Управление всеми кастомными формулами СП
  - Список существующих формул
  - Кнопки редактирования и удаления
  - Новая кнопка "+ Новая формула"

### 4. **Интеграция в админ-панель** ✅

- Добавлен CustomFormulaManager на страницу `/admin/sp/[code]`
- Админ видит раздел "Кастомные формулы СП" в начале
- Может создавать, редактировать и удалять формулы

### 5. **Поддержка в расчётах** ✅

- API `/api/formulas/compute` обновлён, поддерживает оба типа формул
- Параметр `spCode` позволяет загружать кастомные формулы
- FormulaBlockView передаёт `spCode` при расчётах

### 6. **Реестр кастомных формул** ✅

- [lib/formulas/custom.ts](lib/formulas/custom.ts) - конвертация DB записей в FormulaBlock
- [lib/formulas/custom-registry.ts](lib/formulas/custom-registry.ts) - загрузка и кеширование кастомных формул

## 🚀 Следующие шаги

### 1. Применить миграцию БД

```bash
node scripts/run-migration.mjs
```

Или вручную:
1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. SQL Editor
3. Вставьте [0005_custom_formula_blocks.sql](supabase/migrations/0005_custom_formula_blocks.sql)
4. Run

### 2. Протестировать конструктор

1. Откройте `/admin/sp/СП296.1325800.2017` (замените на реальный СП)
2. Найдите "Кастомные формулы СП"
3. Нажмите "+ Новая формула"
4. Заполните форму:
   ```
   Название: Тестовая формула
   LaTeX: \sigma = \dfrac{N}{A}
   Параметры:
     - N (Сила) | кН | min: 0
     - A (Площадь) | мм² | min: 1
   Выражение: (values.N * 1000) / values.A
   Результат: σ | МПа
   ```
5. Протестируйте с N=100, A=500
6. Сохраните

### 3. Проверить на публичной странице

1. Откройте `/sp/СП296.1325800.2017?clause=5` (любой пункт)
2. Формула должна появиться с интерактивными полями
3. Введите параметры - результат посчитается в реальном времени

## 📖 Документация

Полная инструкция для админов: [CUSTOM_FORMULAS_GUIDE.md](CUSTOM_FORMULAS_GUIDE.md)

## Архитектура

```
┌──────────────────────────────────────────────────────────┐
│ Admin Panel: /admin/sp/[code]                            │
│ ├─ CustomFormulaManager (список формул)                  │
│ │  ├─ FormulaBuilder (создание/редактирование)          │
│ │  │  ├─ ParamEditor (управление параметрами)           │
│ │  │  ├─ LaTeX editor                                    │
│ │  │  ├─ Expression editor                               │
│ │  │  └─ Test section                                    │
│ │  └─ List (существующие формулы)                       │
└──────────────────────────────────────────────────────────┘
                           ↓
           API Routes (CRUD + validation)
                           ↓
┌──────────────────────────────────────────────────────────┐
│ Supabase Database                                        │
│ ├─ custom_formula_blocks table                           │
│ ├─ RLS policies (founder only)                           │
│ └─ Soft delete (is_active)                               │
└──────────────────────────────────────────────────────────┘
                           ↓
┌──────────────────────────────────────────────────────────┐
│ Public Pages: /sp/[code]?clause=...                      │
│ ├─ SpClauseView (загружает формулы)                      │
│ ├─ FormulaBlockView (отображает + рассчитывает)         │
│ └─ /api/formulas/compute (поддерживает custom)           │
└──────────────────────────────────────────────────────────┘
```

## Основные возможности

✅ **Создание формул через UI** - никакого кода не требуется
✅ **Параметры с метаданными** - единицы, диапазоны, описания
✅ **LaTeX поддержка** - красивое отображение формул
✅ **JavaScript выражения** - полная гибкость расчётов
✅ **Встроенный тестер** - проверка до сохранения
✅ **Безопасность** - RLS, изолированное выполнение кода
✅ **Версионирование** - created_at, updated_at
✅ **Мягкое удаление** - данные восстанавливаемые

## Примеры вычислений

```javascript
// Простое деление
values.N / values.A

// С константой и конвертацией
(values.N * 1000) / values.A

// Квадратный корень
Math.sqrt(values.x * values.y)

// Площадь окружности
Math.PI * values.r * values.r

// Сложная формула
(values.M * 1_000_000) / values.W
```

## Безопасность

- Функции выполняются в изолированной среде (new Function)
- Доступны только `values` и `Math`
- Рекомендуется для расчётов, не требующих сложной логики
- Для более продвинутых расчётов можно расширить набор доступных функций

## Потенциальные улучшения

- [ ] Импорт/экспорт формул (JSON)
- [ ] Категории формул
- [ ] Рекомендуемые значения параметров
- [ ] История изменений (версионирование)
- [ ] Поиск и фильтрация формул
- [ ] Визуальный конструктор выражений (drag-drop)
- [ ] Таблицы нормативных значений
- [ ] Встраивание в документацию (comments)

---

**Готово к использованию! Примените миграцию и начните создавать формулы.**
